;=============================================================================
; glb_altaz_to_local
;
;  v is a point on the surface in the body frame, r is a direction from that 
;  point in the local frame.
;
;=============================================================================
function glb_altaz_to_local, gbxp, v, r
@nv_lib.include
 gbdp = class_extract(gbxp, 'GLOBE')
 gbd = nv_dereference(gbdp)

 sv = size(v)
 nv = sv[1]
 nt = n_elements(gbd)

 alt = r[*,0,*]
 az = r[*,1,*]
 mag = r[*,2,*]

 result = dblarr(nv,3,nt, /nozero)

 proj = mag*cos(alt)
 result[*,0,*] = -proj * sin(az)
 result[*,1,*] = mag * cos(az)
 result[*,2,*] = mag * sin(alt)

 return, result
end
;=============================================================================
