;=============================================================================
; glb_local_to_altaz
;
;  v is a point on the surface in the body frame, r is a direction from that 
;  point in the local frame.
;
;=============================================================================
function glb_local_to_altaz, gbxp, v, _r
@nv_lib.include
 gbdp = class_extract(gbxp, 'GLOBE')
 gbd = nv_dereference(gbdp)

 sv = size(v)
 nv = sv[1]
 nt = n_elements(gbd)

 r = v_unit(_r, mag=mag)
 alt = asin(r[*,2,*])
 az = -atan(r[*,0,*], r[*,1,*])		; azimuth from north, increasing westward

 result = dblarr(nv,3,nt, /nozero)
 result[*,0,*] = alt
 result[*,1,*] = az
 result[*,2,*] = mag

 return, result
end
;=============================================================================
