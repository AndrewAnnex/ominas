;=============================================================================
; glb_body_to_local
;
;  v is a point on the surface in the body frame, r is a direction from that 
;  point in the body frame.
;
; Local coordinate system is cartesian w axis 0 toward the east, 1 north, and
; 2 zenith.
;
;=============================================================================
function glb_body_to_local, gbxp, v, r
@nv_lib.include
 gbdp = class_extract(gbxp, 'GLOBE')
 gbd = nv_dereference(gbdp)

 sv = size(v)
 nv = sv[1]
 nt = n_elements(gbd)

 z = dblarr(nv,3,nt) & z[*,2,*] = 1d

 zenith = glb_surface_normal(gbdp, v)
 east = v_unit(v_cross(z, zenith))
 north = v_cross(zenith, east)

 result = dblarr(nv,3,nt, /nozero)
 result[*,0,*] = v_inner(east, r)
 result[*,1,*] = v_inner(north, r)
 result[*,2,*] = v_inner(zenith, r)

 return, result
end
;=============================================================================
